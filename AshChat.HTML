<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PRO CHAT - MASTER ADMIN 2.0</title>
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;600;700&display=swap" rel="stylesheet">
    <script>
        if (sessionStorage.getItem("vault_access") !== "vault1") { window.location.href = "admin.html"; }
    </script>
    <style>
        :root {
            --bg: #020617;
            --card: #0f172a;
            --primary: #3b82f6;
            --danger: #ef4444;
            --text: #f8fafc;
            --accent: #10b981;
        }
        body { 
            background: var(--bg); color: var(--text); 
            font-family: 'Plus Jakarta Sans', sans-serif; margin: 0; padding: 20px;
        }
        .header { display: flex; justify-content: space-between; align-items: center; border-bottom: 2px solid #1e293b; padding-bottom: 20px; margin-bottom: 30px; }
        .grid { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 20px; }
        .section { background: var(--card); border-radius: 16px; padding: 20px; border: 1px solid #1e293b; overflow: hidden; }
        h2 { margin-top: 0; color: var(--primary); font-size: 18px; display: flex; align-items: center; gap: 10px; }
        
        table { width: 100%; border-collapse: collapse; margin-top: 15px; }
        th { text-align: left; font-size: 11px; color: #64748b; padding: 10px; border-bottom: 1px solid #1e293b; text-transform: uppercase; }
        td { padding: 10px; font-size: 13px; border-bottom: 1px solid #1e293b; }
        
        .btn-del { background: rgba(239, 68, 68, 0.1); color: var(--danger); border: 1px solid var(--danger); padding: 4px 8px; border-radius: 6px; cursor: pointer; font-size: 10px; }
        .btn-spy { background: rgba(59, 130, 246, 0.1); color: var(--primary); border: 1px solid var(--primary); padding: 4px 8px; border-radius: 6px; cursor: pointer; font-size: 10px; margin-right: 5px; }
        
        /* CHAT MONITOR STYLES */
        #spy-monitor { grid-column: span 2; min-height: 400px; display: flex; flex-direction: column; border: 2px solid var(--accent); }
        #chat-log { flex: 1; background: #020617; border-radius: 8px; padding: 15px; overflow-y: auto; max-height: 500px; display: flex; flex-direction: column; gap: 8px; }
        .log-entry { font-size: 13px; padding: 8px; border-radius: 6px; background: #1e293b; border-left: 3px solid var(--primary); }
        .log-entry.image { border-left-color: var(--accent); }
        .log-entry b { color: var(--primary); }
        .timestamp { font-size: 10px; opacity: 0.5; float: right; }
        
        .stat-card { background: var(--primary); color: white; padding: 10px 20px; border-radius: 10px; font-weight: bold; }
        .active-row { background: rgba(59, 130, 246, 0.1); }

        @media (max-width: 900px) { .grid { grid-template-columns: 1fr; } #spy-monitor { grid-column: span 1; } }
    </style>
</head>
<body>

    <div class="header">
        <div>
            <h1 style="margin:0">Developer Control Panel 2.0</h1>
            <p style="color:#64748b; margin:5px 0 0 0;">Master Database Access</p>
        </div>
        <div id="total-users" class="stat-card">Users: 0</div>
    </div>

    <div class="grid">
        <div class="section">
            <h2>üë• All Registered Users</h2>
            <div style="max-height: 300px; overflow-y: auto;">
                <table>
                    <thead>
                        <tr><th>ID</th><th>NAME</th><th>PASS</th><th>ACTION</th></tr>
                    </thead>
                    <tbody id="user-table"></tbody>
                </table>
            </div>
        </div>

        <div class="section">
            <h2>üí¨ Active Groups</h2>
            <div style="max-height: 300px; overflow-y: auto;">
                <table>
                    <thead>
                        <tr><th>CODE</th><th>NAME</th><th>ACTION</th></tr>
                    </thead>
                    <tbody id="group-table"></tbody>
                </table>
            </div>
        </div>

        <div class="section" id="spy-monitor">
            <h2>üëÅÔ∏è Live Chat Monitor: <span id="current-spy-target" style="color:var(--accent)">Select a group...</span></h2>
            <div id="chat-log">
                <div style="text-align:center; margin-top:100px; opacity:0.3;">
                    Click "VIEW CHATS" on a group to see messages here
                </div>
            </div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getDatabase, ref, onValue, remove, off } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

        const firebaseConfig = {
            apiKey: "AIzaSyCYwds3VZWOBl3dq9cXBliqLkXW8P2n4XQ",
            authDomain: "my-chat-app-50074.firebaseapp.com",
            databaseURL: "https://my-chat-app-50074-default-rtdb.firebaseio.com",
            projectId: "my-chat-app-50074",
            storageBucket: "my-chat-app-50074.firebasestorage.app",
            messagingSenderId: "40034921623",
            appId: "1:40034921623:web:875f6c7a87c9b6bef54dd2"
        };

        const app = initializeApp(firebaseConfig);
        const db = getDatabase(app);
        let currentSpyRef = null;

        // --- LOAD USERS ---
        onValue(ref(db, 'users'), (snapshot) => {
            const data = snapshot.val();
            const table = document.getElementById('user-table');
            table.innerHTML = "";
            let count = 0;
            if(data) {
                Object.entries(data).forEach(([uid, info]) => {
                    count++;
                    table.innerHTML += `
                        <tr>
                            <td style="font-family:monospace">${uid}</td>
                            <td><b>${info.name}</b></td>
                            <td style="color:#eab308">${info.pass}</td>
                            <td><button class="btn-del" onclick="deleteUser('${uid}')">DEL</button></td>
                        </tr>`;
                });
            }
            document.getElementById('total-users').innerText = "Users: " + count;
        });

        // --- LOAD GROUPS ---
        onValue(ref(db, 'groups_meta'), (snapshot) => {
            const data = snapshot.val();
            const table = document.getElementById('group-table');
            table.innerHTML = "";
            if(data) {
                Object.entries(data).forEach(([gid, info]) => {
                    table.innerHTML += `
                        <tr id="row-${gid}">
                            <td style="font-family:monospace">${gid}</td>
                            <td><b>${info.name}</b></td>
                            <td style="white-space:nowrap">
                                <button class="btn-spy" onclick="spyGroup('${gid}', '${info.name.replace(/'/g, "\\'")}')">VIEW CHATS</button>
                                <button class="btn-del" onclick="deleteGroup('${gid}')">NUKE</button>
                            </td>
                        </tr>`;
                });
            }
        });

        // --- CHAT SPY LOGIC ---
        window.spyGroup = (gid, name) => {
            // Cleanup old listener
            if(currentSpyRef) off(currentSpyRef);
            
            document.getElementById('current-spy-target').innerText = "#" + name + " (" + gid + ")";
            const log = document.getElementById('chat-log');
            log.innerHTML = "Opening encrypted tunnel...";

            currentSpyRef = ref(db, 'messages/' + gid);
            onValue(currentSpyRef, (snapshot) => {
                log.innerHTML = "";
                const msgs = snapshot.val();
                if(!msgs) {
                    log.innerHTML = "<div style='text-align:center; padding:20px; opacity:0.5;'>No messages in this group yet.</div>";
                    return;
                }

                Object.values(msgs).forEach(m => {
                    const div = document.createElement('div');
                    const isFile = m.type === 'image' || m.type === 'file';
                    div.className = `log-entry ${m.type === 'image' ? 'image' : ''}`;
                    
                    let content = `<b>${m.sname}:</b> `;
                    if(m.type === 'image') {
                        content += `<span style="color:var(--accent)">[Sent an Image]</span><br><img src="${m.fileData}" style="max-width:150px; border-radius:5px; margin-top:5px;">`;
                    } else if(m.type === 'file') {
                        content += `<span style="color:var(--accent)">[Sent File: ${m.fileName}]</span>`;
                    } else {
                        content += `<span>${m.text}</span>`;
                    }
                    
                    div.innerHTML = `<span class="timestamp">${new Date(m.timestamp || Date.now()).toLocaleTimeString()}</span>` + content;
                    log.appendChild(div);
                });
                log.scrollTop = log.scrollHeight;
            });
        };

        // --- DELETION ACTIONS ---
        window.deleteUser = (uid) => { if(confirm("Erase user?")) remove(ref(db, 'users/' + uid)); };
        window.deleteGroup = (gid) => { 
            if(confirm("Delete everything in this group?")) {
                remove(ref(db, 'groups_meta/' + gid));
                remove(ref(db, 'messages/' + gid));
            }
        };

    </script>
</body>
</html>