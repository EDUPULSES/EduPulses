<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>EduPulses Pro Vault</title>
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-database-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-storage-compat.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        /* Unified Theme Variables */
        :root {
            --bg: #0b141a;
            --panel: #111b21;
            --input-bg: #2a3942;
            --text: #e9edef;
            --subtext: #8696a0;
            --accent: #00a884;
            --sent-bubble: #005c4b;
            --shadow: rgba(0,0,0,0.3);
            --border: #222d34;
        }

        [data-theme="light"] {
            --bg: #f0f2f5;
            --panel: #ffffff;
            --input-bg: #f0f2f5;
            --text: #111b21;
            --subtext: #667781;
            --accent: #008069;
            --sent-bubble: #d9fdd3;
            --shadow: rgba(0,0,0,0.1);
            --border: #e9edef;
        }

        * { box-sizing: border-box; transition: background 0.3s, color 0.3s; -webkit-tap-highlight-color: transparent; }
        
        body { 
            margin: 0; 
            font-family: 'Segoe UI', Roboto, Helvetica, Arial, sans-serif; 
            background: var(--bg); 
            color: var(--text); 
            height: 100dvh; 
            display: flex; 
            flex-direction: column;
            overflow: hidden;
        }

        /* Responsive Header */
        header { 
            background: var(--panel); 
            padding: 0 20px; 
            display: flex; 
            align-items: center; 
            justify-content: space-between; 
            height: 65px; 
            box-shadow: 0 2px 8px var(--shadow);
            z-index: 100;
        }

        .header-actions { display: flex; gap: 15px; align-items: center; }

        /* Modern Chat Window */
        #chat-window { 
            flex: 1; 
            display: flex; 
            flex-direction: column; 
            width: 100%;
            max-width: 1200px;
            margin: 0 auto;
            background: var(--bg);
            border-left: 1px solid var(--border);
            border-right: 1px solid var(--border);
        }

        #messages-container { 
            flex: 1; 
            overflow-y: auto; 
            padding: 20px; 
            display: flex; 
            flex-direction: column; 
            gap: 8px; 
            background-image: url('https://user-images.githubusercontent.com/15075759/28719144-86dc0f70-73b1-11e7-911d-60d70fcded21.png');
            background-blend-mode: overlay;
        }

        /* Adaptive Bubbles */
        .bubble { 
            max-width: 75%; 
            padding: 8px 12px; 
            border-radius: 12px; 
            background: var(--panel); 
            align-self: flex-start; 
            box-shadow: 0 1px 1px var(--shadow);
            font-size: 15px;
            position: relative;
            animation: popIn 0.2s ease-out;
        }
        @keyframes popIn { from { transform: scale(0.95); opacity: 0; } to { transform: scale(1); opacity: 1; } }
        
        .bubble.sent { align-self: flex-end; background: var(--sent-bubble); }
        .time { font-size: 11px; color: var(--subtext); margin-top: 4px; text-align: right; }

        /* Responsive Vault Switcher */
        #tab-switcher { 
            position: fixed; inset: 0; background: var(--bg); 
            z-index: 2000; display: none; padding: 25px; 
        }

        .tab-grid { 
            display: grid; 
            grid-template-columns: repeat(auto-fill, minmax(160px, 1fr)); 
            gap: 15px; 
            margin-top: 20px; 
        }

        .tab-item { 
            background: var(--panel); 
            border-radius: 16px; 
            padding: 20px; 
            border: 2px solid transparent;
            cursor: pointer;
            position: relative;
            transition: 0.2s cubic-bezier(0.4, 0, 0.2, 1);
            display: flex;
            flex-direction: column;
            align-items: center;
            text-align: center;
            box-shadow: 0 4px 12px var(--shadow);
        }

        /* HIGHLIGHTED ACTIVE STATE */
        .tab-item.active { 
            border-color: var(--accent); 
            background: var(--input-bg);
            transform: translateY(-5px);
            box-shadow: 0 0 15px rgba(0, 168, 132, 0.3);
        }
        .tab-item.active::after {
            content: "\f058"; font-family: "Font Awesome 6 Free"; font-weight: 900;
            position: absolute; top: 10px; left: 10px; color: var(--accent);
        }

        /* Input Bar */
        .input-bar { 
            background: var(--panel); padding: 10px 15px; 
            display: flex; align-items: center; gap: 10px; 
        }
        .text-input { 
            flex: 1; background: var(--input-bg); border-radius: 25px; 
            padding: 12px 20px; border: none; color: var(--text); outline: none; 
        }

        /* Loader */
        #loader { 
            position: fixed; inset: 0; background: var(--bg); z-index: 9999; 
            display: none; align-items: center; justify-content: center; 
        }
    </style>
</head>
<body data-theme="dark">

    <div id="loader"><i class="fas fa-circle-notch fa-spin" style="color:var(--accent); font-size: 40px;"></i></div>

    <header>
        <div style="display:flex; align-items:center; gap:12px;">
            <i class="fas fa-vault" style="color:var(--accent); font-size: 24px;"></i>
            <span id="current-vault-name" style="font-weight: 700; font-size: 20px;">EduPulses Vault</span>
        </div>
        <div class="header-actions">
            <i class="fas fa-moon" id="theme-btn" onclick="toggleTheme()" style="cursor:pointer; font-size: 20px;"></i>
            <div onclick="openTabs()" style="background:var(--accent); color:white; padding:5px 12px; border-radius:15px; font-weight:bold; cursor:pointer;">
                <i class="fas fa-tabs"></i> <span id="tab-count">0</span>
            </div>
        </div>
    </header>

    <div id="chat-window">
        <div id="messages-container"></div>
        <div class="input-bar">
            <label for="file-up" style="cursor:pointer">
                <i class="fas fa-plus" style="color:var(--subtext); font-size: 22px;"></i>
                <input type="file" id="file-up" hidden onchange="uploadBinary(this)">
            </label>
            <input type="text" id="msg-input" class="text-input" placeholder="Type a message..." onkeypress="if(event.key==='Enter') sendMessage()">
            <i class="fas fa-paper-plane" onclick="sendMessage()" style="color:var(--accent); font-size: 24px; cursor:pointer"></i>
        </div>
    </div>

    <div id="tab-switcher">
        <div style="display:flex; justify-content:space-between; align-items:center; max-width: 1200px; margin: 0 auto;">
            <h2 style="font-size: 28px;">Your Vaults</h2>
            <i class="fas fa-plus-circle" style="font-size:35px; color:var(--accent); cursor:pointer" onclick="createNewVault()"></i>
        </div>
        <div class="tab-grid" id="grid-list" style="max-width: 1200px; margin: 20px auto;"></div>
        <center><button onclick="closeTabs()" style="margin-top:40px; padding:15px 50px; background:var(--accent); border:none; color:white; border-radius:30px; font-weight:bold; font-size:16px; cursor:pointer;">Back to Chat</button></center>
    </div>

    <script>
        // CONFIG
        const firebaseConfig = {
            apiKey: "AIzaSyAHDrCP8icHUETqPxIgKr4Mr-V-TFx0vWk",
            authDomain: "chat-per-edupulses.firebaseapp.com",
            databaseURL: "https://chat-per-edupulses-default-rtdb.firebaseio.com",
            projectId: "chat-per-edupulses",
            storageBucket: "chat-per-edupulses.firebasestorage.app",
            appId: "1:246486252505:web:9b3a6fbf8cf0dbc340b7c8"
        };

        firebase.initializeApp(firebaseConfig);
        const db = firebase.database();
        const storage = firebase.storage();
        const VAULT_PATH = "edu_v3_vaults";

        let activeVaultId = localStorage.getItem('last_vault');

        // Theme Toggle
        function toggleTheme() {
            const body = document.body;
            const btn = document.getElementById('theme-btn');
            if (body.getAttribute('data-theme') === 'dark') {
                body.setAttribute('data-theme', 'light');
                btn.className = "fas fa-sun";
                localStorage.setItem('theme', 'light');
            } else {
                body.setAttribute('data-theme', 'dark');
                btn.className = "fas fa-moon";
                localStorage.setItem('theme', 'dark');
            }
        }

        // Restore Theme Preference
        if(localStorage.getItem('theme') === 'light') toggleTheme();

        // Data Management
        db.ref(`${VAULT_PATH}/meta`).on('value', snap => {
            const vaults = snap.val() || {};
            document.getElementById('tab-count').innerText = Object.keys(vaults).length;
            renderGrid(vaults);
            if(!activeVaultId && Object.keys(vaults).length > 0) selectVault(Object.keys(vaults)[0]);
            else if(activeVaultId) selectVault(activeVaultId);
        });

        function renderGrid(vaults) {
            const list = document.getElementById('grid-list');
            list.innerHTML = '';
            Object.entries(vaults).forEach(([id, info]) => {
                const item = document.createElement('div');
                item.className = `tab-item ${activeVaultId === id ? 'active' : ''}`;
                item.onclick = () => selectVault(id);
                item.innerHTML = `
                    <i class="fas fa-folder" style="font-size:30px; color:var(--accent); margin-bottom:10px;"></i>
                    <div style="font-weight:600;">${info.name}</div>
                    <i class="fas fa-trash" style="position:absolute; bottom:10px; right:10px; font-size:12px; opacity:0.5" onclick="event.stopPropagation(); removeVault('${id}')"></i>
                `;
                list.appendChild(item);
            });
        }

        function selectVault(id) {
            activeVaultId = id;
            localStorage.setItem('last_vault', id);
            db.ref(`${VAULT_PATH}/meta/${id}`).once('value', s => {
                document.getElementById('current-vault-name').innerText = s.val()?.name || "Vault";
            });
            closeTabs();

            db.ref(`${VAULT_PATH}/chats/${id}`).off();
            db.ref(`${VAULT_PATH}/chats/${id}`).on('value', snap => {
                const msgBox = document.getElementById('messages-container');
                msgBox.innerHTML = '';
                const messages = snap.val() || {};
                Object.values(messages).forEach(m => {
                    const bubble = document.createElement('div');
                    bubble.className = "bubble " + (m.type === 'system' ? '' : 'sent');
                    bubble.innerHTML = `<div>${m.text}</div><div class="time">${new Date(m.time).toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'})}</div>`;
                    msgBox.appendChild(bubble);
                });
                msgBox.scrollTop = msgBox.scrollHeight;
            });
        }

        function sendMessage() {
            const inp = document.getElementById('msg-input');
            if(!inp.value.trim()) return;
            db.ref(`${VAULT_PATH}/chats/${activeVaultId}`).push({
                text: inp.value,
                time: Date.now()
            });
            inp.value = "";
        }

        function createNewVault() {
            const n = prompt("Vault Name:");
            if(n) db.ref(`${VAULT_PATH}/meta/v_${Date.now()}`).set({ name: n, updated: Date.now() });
        }

        function removeVault(id) {
            if(confirm("Delete Vault?")) {
                db.ref(`${VAULT_PATH}/meta/${id}`).remove();
                db.ref(`${VAULT_PATH}/chats/${id}`).remove();
            }
        }

        function openTabs() { document.getElementById('tab-switcher').style.display = "block"; }
        function closeTabs() { document.getElementById('tab-switcher').style.display = "none"; }
    </script>
</body>
</html>
